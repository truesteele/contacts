# Ralph Progress Log
Loop: pipeline-crm
Started: 2026-02-22
---

## Codebase Patterns
- Pages are `'use client'` React components in `job-matcher-ai/app/tools/`
- API routes at `job-matcher-ai/app/api/network-intel/` use edge runtime
- Supabase service client: `import { supabase } from '@/lib/supabase'`
- shadcn/ui components available: badge, button, card, checkbox, dropdown-menu, input, scroll-area, select, separator, sheet, tabs, textarea, tooltip
- Dark mode: always include `dark:` Tailwind variants
- `cn()` utility from `@/lib/utils` for conditional classnames
- Contact table has integer `id` column (not uuid)
- Supabase MCP server is `supabase-contacts` (NOT `supabase_crm`)
- No em dashes in UI text (user preference)

---

## Iteration Log

### US-001: Create Supabase Migration (2026-02-22)
- Created `supabase/migrations/20260222_add_pipeline_crm.sql`
- `pipelines` table: uuid PK, name, slug (unique), entity, stages (jsonb with 7 default stages), timestamps
- `deals` table: uuid PK, pipeline_id (FK cascade), contact_id (int FK to contacts), title, stage, amount, close_date, notes, next_action, next_action_date, source, lost_reason, position, timestamps
- Indexes: `idx_deals_pipeline_stage` (pipeline_id, stage), `idx_deals_contact_id` (contact_id)
- Seeded 3 pipelines: Kindora Fundraising, Outdoorithm Partnerships, True Steele Consulting
- Applied via `supabase-contacts` MCP `apply_migration`, verified with `execute_sql`
- Pipeline IDs: kindora=5359ab5a, outdoorithm=9699ccfb, truesteele=a8ce2a4f

### US-002: Install dnd-kit and Create API Routes (2026-02-22)
- Installed `@dnd-kit/core`, `@dnd-kit/sortable`, `@dnd-kit/utilities` via npm
- Created 4 API route files, all with `export const runtime = 'edge'`:
  - `app/api/network-intel/pipeline/route.ts` - GET all pipelines, POST create pipeline
  - `app/api/network-intel/pipeline/deals/route.ts` - GET deals by pipeline_id (with contact join + pagination), POST create deal (auto-calculates position)
  - `app/api/network-intel/pipeline/deals/[id]/route.ts` - PATCH update deal fields, DELETE soft-delete (sets stage to 'lost')
  - `app/api/network-intel/pipeline/deals/reorder/route.ts` - PATCH batch update stage+position for drag-and-drop reorder
- Next.js 15 dynamic route params use `Promise<{ id: string }>` pattern (must await params)
- Deal SELECT includes contact join: `*, contacts(id, first_name, last_name, company, position, headline, city, state)`
- Typecheck passes clean

### US-003: Build the Kanban Board Component (2026-02-22)
- Created 3 components in `components/pipeline/`:
  - `deal-card.tsx` - Draggable card with useSortable hook, shows title, contact name + company, amount badge, next action + date, source badge, days in stage
  - `kanban-column.tsx` - Droppable column with useDroppable hook, SortableContext with verticalListSortingStrategy, header shows stage name + color dot + deal count + total value, ScrollArea for vertical overflow
  - `kanban-board.tsx` - DndContext with closestCorners collision, PointerSensor with 5px activation distance, DragOverlay for floating card, optimistic updates via onDealsChange callback, background API persist via persistReorder()
- Exported `Deal` and `DealContact` types from deal-card.tsx for reuse
- Stage keys derived from stage names via lowercase + underscore (e.g., "Reached Out" -> "reached_out")
- Drag between columns: handleDragOver moves deal optimistically, handleDragEnd recalculates positions for both source and target columns and persists
- Drag within column: arrayMove for reorder, positions recalculated sequentially
- hideLost prop filters out the "lost" column when true
- Typecheck passes clean
