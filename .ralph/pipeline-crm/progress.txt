# Ralph Progress Log
Loop: pipeline-crm
Started: 2026-02-22
---

## Codebase Patterns
- Pages are `'use client'` React components in `job-matcher-ai/app/tools/`
- API routes at `job-matcher-ai/app/api/network-intel/` use edge runtime
- Supabase service client: `import { supabase } from '@/lib/supabase'`
- shadcn/ui components available: badge, button, card, checkbox, dropdown-menu, input, scroll-area, select, separator, sheet, tabs, textarea, tooltip
- Dark mode: always include `dark:` Tailwind variants
- `cn()` utility from `@/lib/utils` for conditional classnames
- Contact table has integer `id` column (not uuid)
- Supabase MCP server is `supabase-contacts` (NOT `supabase_crm`)
- No em dashes in UI text (user preference)

---

## Iteration Log

### US-001: Create Supabase Migration (2026-02-22)
- Created `supabase/migrations/20260222_add_pipeline_crm.sql`
- `pipelines` table: uuid PK, name, slug (unique), entity, stages (jsonb with 7 default stages), timestamps
- `deals` table: uuid PK, pipeline_id (FK cascade), contact_id (int FK to contacts), title, stage, amount, close_date, notes, next_action, next_action_date, source, lost_reason, position, timestamps
- Indexes: `idx_deals_pipeline_stage` (pipeline_id, stage), `idx_deals_contact_id` (contact_id)
- Seeded 3 pipelines: Kindora Fundraising, Outdoorithm Partnerships, True Steele Consulting
- Applied via `supabase-contacts` MCP `apply_migration`, verified with `execute_sql`
- Pipeline IDs: kindora=5359ab5a, outdoorithm=9699ccfb, truesteele=a8ce2a4f

### US-002: Install dnd-kit and Create API Routes (2026-02-22)
- Installed `@dnd-kit/core`, `@dnd-kit/sortable`, `@dnd-kit/utilities` via npm
- Created 4 API route files, all with `export const runtime = 'edge'`:
  - `app/api/network-intel/pipeline/route.ts` - GET all pipelines, POST create pipeline
  - `app/api/network-intel/pipeline/deals/route.ts` - GET deals by pipeline_id (with contact join + pagination), POST create deal (auto-calculates position)
  - `app/api/network-intel/pipeline/deals/[id]/route.ts` - PATCH update deal fields, DELETE soft-delete (sets stage to 'lost')
  - `app/api/network-intel/pipeline/deals/reorder/route.ts` - PATCH batch update stage+position for drag-and-drop reorder
- Next.js 15 dynamic route params use `Promise<{ id: string }>` pattern (must await params)
- Deal SELECT includes contact join: `*, contacts(id, first_name, last_name, company, position, headline, city, state)`
- Typecheck passes clean

### US-003: Build the Kanban Board Component (2026-02-22)
- Created 3 components in `components/pipeline/`:
  - `deal-card.tsx` - Draggable card with useSortable hook, shows title, contact name + company, amount badge, next action + date, source badge, days in stage
  - `kanban-column.tsx` - Droppable column with useDroppable hook, SortableContext with verticalListSortingStrategy, header shows stage name + color dot + deal count + total value, ScrollArea for vertical overflow
  - `kanban-board.tsx` - DndContext with closestCorners collision, PointerSensor with 5px activation distance, DragOverlay for floating card, optimistic updates via onDealsChange callback, background API persist via persistReorder()
- Exported `Deal` and `DealContact` types from deal-card.tsx for reuse
- Stage keys derived from stage names via lowercase + underscore (e.g., "Reached Out" -> "reached_out")
- Drag between columns: handleDragOver moves deal optimistically, handleDragEnd recalculates positions for both source and target columns and persists
- Drag within column: arrayMove for reorder, positions recalculated sequentially
- hideLost prop filters out the "lost" column when true
- Typecheck passes clean

### US-004: Build the Pipeline Page (2026-02-22)
- Created `app/tools/pipeline/page.tsx` as `'use client'` page with Suspense boundary for useSearchParams
- Pipeline selector: shadcn Select at top, reads `?pipeline=slug` from URL, defaults to first pipeline
- URL sync: `router.replace()` with `scroll: false` on pipeline switch for bookmarkable URLs
- "New Deal" button opens a Sheet (right drawer) with form fields: title, contact search, amount, close date, source, notes, next action + date
- Contact search: debounced (300ms), queries new API endpoint, shows dropdown with name + company, click to select
- Created `app/api/network-intel/pipeline/contacts/route.ts` - GET endpoint for contact search by name/company (ilike, limit 20)
- KanbanBoard component wired in with deals, stages from active pipeline, hideLost toggle
- "Lost" deals hidden by default with toggle button showing count
- Stats bar: total deals, total pipeline value, per-stage counts with color dots (uses existing `stat-pill` CSS class)
- Loading/error states follow ask-readiness page pattern (spinner, back arrow, icon)
- Back arrow navigates to `/tools/network-intel` (consistent with other tool pages)
- Deal click handler is a no-op placeholder -- US-005 will add deal detail sheet
- Typecheck passes clean

### US-005: Add Deal Detail Sheet and Edit Capability (2026-02-22)
- Created `components/pipeline/deal-detail-sheet.tsx` using shadcn Sheet (right side drawer)
- Editable form fields: title, stage (select with color dots), amount, close date, notes, next action + date, source, lost reason (only shown when stage is "lost")
- "Save" button PATCHes the deal via `/api/network-intel/pipeline/deals/[id]`
- Dirty state tracking: Save button disabled until a field changes
- "View Contact" button opens existing `ContactDetailSheet` for the linked contact
- Shows deal creation date and last updated date (formatted as "Mon DD, YYYY")
- Shows days in current stage as a badge (e.g. "5d in stage" or "Moved today")
- Stage selector shows all pipeline stages with color dots
- Wired into pipeline page: `onDealClick` opens the detail sheet, `onDealUpdated` updates local deals state
- Nested sheet support: deal detail sheet -> contact detail sheet
- Follows existing `ContactDetailSheet` pattern: same width, flex column layout, overflow scroll
- Typecheck passes clean

### US-006: Add Pipeline Page to Tools Navigation (2026-02-22)
- Added Pipeline entry to `TOOLS` array in `app/page.tsx` (main dashboard)
- Placed after Ask Readiness in the grid
- Icon: `Columns3` from lucide-react (Kanban-style column icon)
- Accent: indigo-to-violet gradient (distinct from other tools)
- Description: "Track outreach and deals across Kindora, Outdoorithm, and True Steele. Drag-and-drop Kanban board with deal stages, contacts, and notes."
- Links to `/tools/pipeline`
- Typecheck passes clean
- Full production build passes clean (only pre-existing warnings from resend package)
- **ALL 6 STORIES COMPLETE** -- Pipeline CRM feature fully implemented
