# Ralph Progress Log
Loop: campaign-command-center
Started: 2026-02-23
---

## Codebase Patterns
- Next.js 15 + React 19 app at job-matcher-ai/
- shadcn/radix UI components in components/ui/
- 'use client' pages that fetch from /api/ routes on mount via useEffect
- API routes use edge runtime, Supabase server-side via lib/supabase.ts
- SUPABASE_SERVICE_KEY env var (not SUPABASE_KEY)
- Resend already installed (v6.9.2), working send route at app/api/network-intel/outreach/send/route.ts
- Page layout: max-w-7xl mx-auto p-4, page-header class with back arrow
- Existing pages to study: ask-readiness (filterable table), pipeline (kanban + detail sheets)
- campaign_2026 JSONB has: scaffold, personal_outreach (List A), campaign_copy (Lists B-D)
- 317 total contacts: 25 List A, 107 B, 42 C, 143 D
- Contact email priority: personal_email || email || work_email

---

## Iteration Log

### US-001 — Campaign API: Fetch contacts ✓
- **Created:** `app/api/network-intel/campaign/route.ts`
- **Pattern followed:** ask-readiness/route.ts (Supabase pagination, JSONB flattening, edge runtime)
- **Flattened fields:** list, persona, ask_amount, capacity_tier, lifecycle, motivation, channel, subject, has_outreach, has_copy, send_status, donation, responded_at
- **Stats object:** counts by list (A/B/C/D), persona, capacity, lifecycle, send_status
- **TypeScript:** passes clean (`npx tsc --noEmit`)
- **Build:** passes clean (`npx next build`)
- **Notes:** Used `send_status && Object.keys(sendStatus).length > 0` check since send_status defaults to empty `{}`

### US-002 — Campaign API: Update contact + Record donation ✓
- **Created:** `app/api/network-intel/campaign/[id]/route.ts`
- **Pattern followed:** pipeline/deals/[id]/route.ts (PATCH with params Promise, error handling)
- **GET:** Returns single contact with full `campaign_2026` JSONB (not flattened) for the detail sheet
- **PATCH:** Supports three update patterns:
  - Nested field update: `{ section: "personal_outreach", field: "message_body", value: "..." }` — modifies specific nested JSONB field
  - Donation recording: `{ section: "donation", value: { amount, donated_at, source } }` — sets top-level donation
  - Response recording: `{ section: "responded_at", value: "2026-02-25" }` — sets top-level responded_at
  - Send status: `{ section: "send_status", field: "personal_outreach", value: { sent_at, resend_id } }` — merges into send_status object
- **Approach:** Fetch-modify-write (read full JSONB, update in JS, write back) — simpler than raw SQL jsonb_set and safer for preserving other keys
- **TypeScript:** passes clean (`npx tsc --noEmit`)
- **Build:** passes clean (`npx next build`)

### US-003 — Campaign page: Dashboard tab + List A tab ✓
- **Created:** `app/tools/campaign/page.tsx`
- **Modified:** `app/page.tsx` — added Campaign tool to dashboard TOOLS array with Megaphone icon, orange accent
- **Pattern followed:** network-intel/page.tsx (page layout), ask-readiness/page.tsx (data fetching, table, contact selection)
- **Dashboard tab:**
  - Campaign progress: "$X raised of $100K" with green progress bar
  - Stats row: Donors, Total Raised, List A Sent (X/25), Responded
  - Contacts by List: A/B/C/D counts from API stats
  - Breakdown cards: By Persona, By Capacity, Send Status (with colored dots)
  - Phase indicator: computed from current date vs campaign timeline phases
- **List A tab:**
  - Table of contacts with #, Name, Company, Ask ($), Channel, Subject, Status columns
  - Sorted by ask amount descending (leadership/highest asks first)
  - Status shows: draft (gray), sent (blue), responded (yellow), donated (green) with colored dot indicators
  - Rows are clickable — sets selectedContactId + sheetOpen state (ready for US-004 detail sheet)
  - Responsive: Company hidden on mobile, Channel hidden on small, Subject hidden on medium
- **Placeholder tabs:** Lists B-D and Activity show "coming soon" (US-005 and US-008)
- **Types:** Full CampaignContact and CampaignStats interfaces — no `any` in component props
- **Helpers:** getContactStatus(), formatCurrency(), resolveEmail()
- **TypeScript:** passes clean (`npx tsc --noEmit`)
- **Build:** passes clean (`npx next build`) — page is 6.76 kB

### US-004 — Message detail sheet ✓
- **Created:** `components/campaign/message-detail-sheet.tsx`
- **Modified:** `app/tools/campaign/page.tsx` — imported MessageDetailSheet, added useCallback loadData for refresh, rendered sheet
- **Pattern followed:** pipeline/deal-detail-sheet.tsx (Sheet with editable fields, dirty tracking, save button), contact-detail-sheet.tsx (Sheet layout with header)
- **Sheet features:**
  - Fetches full contact data from `GET /api/network-intel/campaign/[id]` on open
  - Scaffold summary badges: List, Persona, Ask Amount, Capacity, Lifecycle, Motivation, Lead Story
  - **List A (personal_outreach):** Editable Subject Line (Input), Message Body (Textarea 8 rows), Follow-Up Text, Thank-You Message, Internal Notes (all Textarea 3 rows), Channel badge (read-only)
  - **Lists B-D (campaign_copy):** Pre-Email Note (only for prior_donor/lapsed), Text Follow-Up Opener, Text Follow-Up Milestone, Thank-You Message (all Textarea), Thank-You Channel badge (read-only)
  - Dirty tracking: compares current values against originals, Save button disabled when clean
  - Save sends only changed fields via individual PATCH calls to `/api/network-intel/campaign/[id]`
  - Save confirmation: button turns green with checkmark for 2 seconds, then resets
  - After save, calls `onUpdated()` → parent re-fetches campaign data from API
- **Integration:** Clicking any row in List A tab opens the sheet for that contact (wired via selectedContactId + sheetOpen state from US-003)
- **Types:** Fully typed interfaces for Campaign2026, Scaffold, PersonalOutreach, CampaignCopy, ContactFull, MessageDetailSheetProps — no `any` in component props
- **TypeScript:** passes clean (`npx tsc --noEmit`)
- **Build:** passes clean (`npx next build`) — page is 10.1 kB

### US-005 — Lists B-D tab with filters ✓
- **Modified:** `app/tools/campaign/page.tsx`
- **Pattern followed:** ask-readiness/page.tsx (filter bar with Select dropdowns, search input, sort headers, ScrollArea table)
- **Filter bar:** 4 dropdowns — List (B/C/D), Persona (Believer/Impact Pro/Network Peer), Capacity (Leadership/Major/Mid/Base/Community), Lifecycle (New/Prior Donor/Lapsed)
- **Search:** Filters by name and company, with clear button
- **Sorting:** Clickable column headers for Name, List, Persona, Ask ($) — with directional arrow icons
- **Table columns:** Name (with company subtitle), List (badge), Persona (badge), Ask $ (mono), Lifecycle (badge), Status (colored dot + label)
- **Empty state:** "No contacts match the current filters" when filters yield zero results
- **Count display:** "Showing X of Y contacts" in top bar
- **Tab label:** Shows count — "Lists B-D (292)"
- **Integration:** Rows are clickable → opens MessageDetailSheet (same as List A)
- **New imports:** Select, SelectContent, SelectItem, SelectTrigger, SelectValue, ScrollArea, Search, Filter, X, ArrowUpDown, ArrowUp, ArrowDown
- **New types:** BcdSortField, LIFECYCLE_LABELS constant
- **TypeScript:** passes clean (`npx tsc --noEmit`)
- **Build:** passes clean (`npx next build`) — page is 12.4 kB

### US-006 — Campaign send API route ✓
- **Created:** `app/api/network-intel/campaign/send/route.ts`
- **Pattern followed:** outreach/send/route.ts (Resend client, textToHtml, sequential sends, error handling)
- **Three email types supported:**
  - `personal_outreach` — reads subject_line + message_body from `campaign_2026.personal_outreach`
  - `pre_email_note` — reads pre_email_note from `campaign_2026.campaign_copy`, subject: "quick note before the big ask"
  - `email_1` — hardcoded Email 1 template from COME_ALIVE_2026_Campaign.md, with per-contact `opener_insert` and `personalization_sentence` from scaffold, subject: "10 trips this year"
- **Resend config:** `RESEND_API_KEY_OC`, from `justin@outdoorithmcollective.org`, reply-to `justinrsteele@gmail.com`
- **Email resolution:** `personal_email || email || work_email` priority order
- **Send status tracking:** After successful send, updates `campaign_2026.send_status.<email_type>` with `{ sent_at, resend_id }`
- **Skip logic:** Contacts already sent for that email_type are skipped (status: 'skipped')
- **Sequential sends:** One at a time to avoid rate limits
- **Response format:** `{ results: [...], total_sent, total_failed, total_skipped }`
- **textToHtml:** Copied from outreach/send/route.ts — Georgia font, paragraph formatting, unsubscribe link
- **TypeScript:** passes clean (`npx tsc --noEmit`)
- **Build:** passes clean (`npx next build`)

### US-007 — Send buttons + status tracking in UI ✓
- **Modified:** `app/tools/campaign/page.tsx`
- **Pattern followed:** outreach-drawer.tsx (send button patterns, sendingIds Set, sendAll pattern)
- **New imports:** Button, Send, SendHorizonal
- **Send state:** `sendingIds` (Set<number> for per-row), `sendingAllA`, `sendingPreEmail`, `sendingEmail1` (booleans for bulk)
- **Send handlers:**
  - `sendCampaignEmails()` — shared helper that POSTs to `/api/network-intel/campaign/send` and returns results
  - `handleSendOne()` — single List A contact, confirm dialog "Send to {name} at {email}?", per-row spinner
  - `handleSendAllA()` — all unsent email-channel List A contacts, confirm dialog with count
  - `handleSendPreEmail()` — prior_donor/lapsed B-D contacts without pre_email_note sent, confirm dialog
  - `handleSendEmail1()` — all B-D contacts without email_1 sent, confirm dialog
- **List A tab changes:**
  - "Send All Unsent (N)" button in header bar — hidden when all are sent
  - Added action column with per-row Send icon button (ghost variant, 7x7px hit area)
  - Send button only shown for email channel contacts in draft status with valid email
  - Per-row spinner while sending, disabled during bulk send
  - `e.stopPropagation()` prevents row click (open detail sheet) when clicking send
- **Lists B-D tab changes:**
  - Two bulk send buttons above search bar: "Send Pre-Email Notes" (outline) and "Send Email 1" (primary)
  - Buttons are mutually disabled while one is sending
  - Spinners while sending, confirm dialogs before send
- **Status indicators:** Already implemented in US-003/US-005 — gray dot (draft), blue dot (sent), yellow dot (responded), green dot (donated)
- **After send:** all handlers call `loadData()` to refresh campaign data from API
- **Confirm dialogs:** `window.confirm()` — no AlertDialog component needed
- **TypeScript:** passes clean (`npx tsc --noEmit`)
- **Build:** passes clean (`npx next build`) — page is 13.3 kB

### US-008 — Activity tab + donation recording ✓
- **Modified:** `app/tools/campaign/page.tsx`
- **Pattern followed:** existing page patterns (Card forms, ScrollArea lists, Select dropdowns, Button actions)
- **New imports:** Input, Separator, MessageSquare, Clock, Plus, Check
- **New types/helpers:** ActivityEvent interface, EMAIL_TYPE_LABELS, SOURCE_OPTIONS, buildActivityFeed(), formatTimestamp()
- **Activity tab features:**
  - **Record Donation form** at top of tab:
    - Contact search with autocomplete dropdown (min 2 chars, shows name + company + ask amount)
    - Selected contact displayed as chip with dismiss button
    - Amount input (number, auto-filled from contact's ask_amount when selected)
    - Date input (defaults to today)
    - Source dropdown: Personal Outreach, Email 1-3, Other
    - Record button with spinner + success checkmark state
    - Calls `PATCH /api/network-intel/campaign/[id]` with donation section
    - Resets form and refreshes data after success
  - **Activity feed** below donation form:
    - Reverse-chronological list built from all contacts' send_status, donation, responded_at
    - Event types: email_sent (blue icon), donation (green icon), response (yellow icon)
    - Each event shows: icon, contact name, event detail (email type/amount/responded), timestamp
    - Timestamps: "Today" shows time, other days show "Feb 24" format
    - Events are clickable → opens MessageDetailSheet for that contact
    - Empty state: "No activity yet — send some emails to get started"
    - ScrollArea for long feeds
- **Record Response quick actions:**
  - **List A tab:** MessageSquare button in action column for contacts with "sent" status
    - Confirmation dialog "Mark {name} as responded?"
    - Per-row spinner while recording, calls PATCH with responded_at = now
  - **Lists B-D tab:** New action column with same MessageSquare button for "sent" contacts
    - Added column header + td, updated colSpan from 6→7 for empty state
- **Dashboard updates live:** Already implemented — dashboardData memo recomputes from contacts array,
  which is refreshed via loadData() after every donation recording, response marking, or send
- **New state:** donationContactSearch, donationContactId, donationAmount, donationDate, donationSource,
  recordingDonation, donationSuccess, respondingIds (Set<number>)
- **TypeScript:** passes clean (`npx tsc --noEmit`)
- **Build:** passes clean (`npx next build`) — page is 15 kB

## ALL STORIES COMPLETE ✓
